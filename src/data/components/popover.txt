<script setup lang="ts">
// Types
import type { VNode } from 'vue';
import type {
    I<%camel%>PopoverEmits,
    I<%camel%>PopoverExpose,
    I<%camel%>PopoverProps,
} from '<%typesImport%>/components/popover';

// Vue
import { cloneVNode, computed, isVNode, ref, toRef } from 'vue';

// Constants
import { DIALOG_LAYERS } from '<%typesImport%>/composables/dialog';
import { ATTACHED_BOX_POSITION } from '<%typesImport%>/composables/attach';

// Composables
import { useDeviceProperties } from '<%composablesImport%>/device-is';
import { useAttach } from '<%composablesImport%>/attach';
import { useDialog } from '<%composablesImport%>/dialog';
import { useClassList } from '<%composablesImport%>/class-list';
import { useAutoFocus, useFocusTrap } from '<%composablesImport%>/focus';

// Components
import <%camel%>SlotCatcher from '<%componentsImport%>/<%camel%>SlotCatcher.vue';

const props = withDefaults(defineProps<I<%camel%>PopoverProps>(), {
    visible: undefined,
    modelValue: undefined,
    position: ATTACHED_BOX_POSITION.BOTTOM_CENTER,
    nudge: 10,
    edgeMargin: 10,
    to: 'body',
    transition: '<%kebab%>-popover-transition',
});

const emit = defineEmits<I<%camel%>PopoverEmits>();

// Data
const target = ref<Element | null>(null);
const box = ref<Element | null>(null);

// Computed
const currentTarget = computed(() => props.target ?? target.value ?? null);

const teleportTo = computed(() => props.to ?? 'body');

const currentStyles = computed(() => {
    const x = $attach.x.value ?? 0;
    const y = $attach.y.value ?? 0;

    return {
        zIndex: $dialog.zIndex.value,
        transform: `translate(${x}px, ${y}px)`,
    };
});

// Composables
const $dialog = useDialog({
    isOpen: computed(() => Boolean(props.visible ?? props.modelValue)),
    triggers: ['clickoutside', 'escape'],
    layer: DIALOG_LAYERS.POPOVER,
    close,
    open,
});

const $properties = useDeviceProperties(
    {
        position: toRef(() => props.position),
        nudge: toRef(() => props.nudge),
        edgeMargin: toRef(() => props.edgeMargin),
        color: toRef(() => props.color),
        size: toRef(() => props.size),
        radius: toRef(() => props.radius),
    },
    toRef(() => props.devices),
);

const $classList = useClassList(
    {
        position: $properties.position,
        color: $properties.color,
        size: $properties.size,
        radius: $properties.radius,
        opened: $dialog.isOpen,
        closed: toRef(() => !$dialog.isOpen.value),
        hidden: toRef(() => $attach.x.value === null || $attach.y.value === null),
    },
    'popover',
);

const $attach = useAttach({
    target: currentTarget,
    box: box,
    position: $properties.position,
    nudge: $properties.nudge,
    edgeMargin: $properties.edgeMargin,
    persistent: toRef(() => props.persistent),
    sticky: toRef(() => !props.noSticky),
    onChange: () => {
        if (props.closeOnMove) $dialog.close();
    },
});

useFocusTrap(computed(() => (props.noFocusTrap ? null : box.value)));

useAutoFocus(computed(() => (props.noAutoFocus ? null : box.value)));

// Methods
function open() {
    emit('open');
    emit('update:modelValue', true);
}

function close() {
    emit('close');
    emit('update:modelValue', false);
}

function findTarget(vnode: VNode): VNode | null {
    if (!isVNode(vnode)) return vnode;

    if (Array.isArray(vnode.children)) {
        vnode.children = vnode.children.map(v => (isVNode(v) ? findTarget(v) : v));
    }

    return cloneVNode(vnode, {
        onVnodeMounted(vnode) {
            if (target.value || !(vnode.el instanceof Element)) return;
            target.value = vnode.el as Element;
        },

        onVnodeBeforeUnmount() {
            if (target.value === vnode.el) {
                target.value = null;
            }
        },
    });
}

// Exports
defineExpose<Readonly<I<%camel%>PopoverExpose>>({
    isOpen: $dialog.isOpen,
    x: $attach.x,
    y: $attach.y,
    target: currentTarget,
    popover: box,
    marker: toRef(() => $dialog.marker),
    open,
    close,
});
</script>

<template>
    <Teleport
        :to="teleportTo"
        :disabled="!to"
    >
        <Transition :name="transition">
            <div
                v-if="$dialog.isOpen.value"
                ref="box"
                v-bind="$dialog.marker"
                :key="`${$dialog.id.description}_${$dialog.isOpen.value}`"
                :class="['<%kebab%>-popover', $classList, classList]"
                :style="currentStyles"
            >
                <slot
                    :open="open"
                    :close="close"
                />
            </div>
        </Transition>
    </Teleport>

    <<%camel%>SlotCatcher :map-v-node="findTarget">
        <slot
            name="target"
            :marker="$dialog.marker"
            :open="open"
            :close="close"
        />
    </<%camel%>SlotCatcher>
</template>

<style>
.<%kebab%>-popover {
    position: fixed;
    top: 0;
    left: 0;
    border-style: solid;

    /* --- <%camel%>Popover - Color --- */
    border-color: var(--<%kebab%>-popover-color-border, transparent);
    background-color: var(--<%kebab%>-popover-color-background, transparent);
    color: var(--<%kebab%>-popover-color-text, inherit);

    /* --- <%camel%>Popover - Size --- */
    border-width: var(--<%kebab%>-popover-size-border, 0);
    padding: var(--<%kebab%>-popover-size-padding, 0);
    box-shadow: var(--<%kebab%>-popover-size-shadow, none);
    font-size: var(--<%kebab%>-popover-size-text, inherit);
    font-weight: var(--<%kebab%>-button-size-text-weight, 400);
    line-height: var(--<%kebab%>-button-size-text-height, 1);

    /* --- <%camel%>Popover - Radius --- */
    border-radius: var(--<%kebab%>-popover-radius-value, 0);
}

/* --- Hidden --- */
.<%kebab%>-popover._popover-hidden {
    opacity: 0;
}

.<%kebab%>-popover-transition-enter-active,
.<%kebab%>-popover-transition-leave-active {
    transition: opacity var(--<%kebab%>-popover-transition-duration, 0.2s)
        var(--<%kebab%>-popover-transition-function, ease);
}

.<%kebab%>-popover-transition-enter-from,
.<%kebab%>-popover-transition-leave-to {
    opacity: 0;
}
</style>